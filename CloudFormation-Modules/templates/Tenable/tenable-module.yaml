AWSTemplateFormatVersion: 2010-09-09
Description: "CloudFormation Template to Create Tenable and AWS Security Hub integration resources."
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Properties
        Parameters:
          - pGLCTSolutionVersion
          - pS3BaseURLForNestedTemplates
      - Label:
          default: Tenable Configuration
        Parameters:
          - pTenableRoleName
          - pTenableContainerIAMRole
          - pPrincipalAws
          - pTenableExternalId
          - pConnectorRoleName
          - pCodeCommitRepositoryName
          - pECRRepositoryName
          - pVpcId
          - pSubnetIds
          - pCreateVpc
          - pVpcCidr
      - Label:
          default: AWS Organization Configuration
        Parameters:
          - pRootOrganizationalUnitId
          - pSecurityAccountId
      - Label:
          default: Tagging Configuration
        Parameters:
          - pTagEnvironment
          - pTagSDLC
          - pTagApplicationName
          - pTagApplicationRole
          - pTagCluster
          - pTagDataClassification
          - pTagDataRetention
          - pTagProjectName
          - pTagProductOwner
          - pTagTechnicalOwner
          - pTagCostCenter
          - pTagBusinessImpact
          - pTagEscalationPath
          - pTagKnowledgeBase
          - pTagHoursOfOperation
          - pTagMaintenanceWindow
          - pTagBackupSchedule
          - pTagOptOut
          - pTagDeploymentMethod
Parameters:
  pGLCTSolutionVersion:
    Description: The Global Logic solution version. Used to trigger updates on the nested StackSets.
    Type: String
  pS3BaseURLForNestedTemplates:
    Type: String
    Description: "Base URL of S3 Bucket for storing Nested CloudFormation templates"
  pRootOrganizationalUnitId:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/root-organizational-unit-id
    Description: SSM Parameter for Root Organizational Unit ID
    Type: AWS::SSM::Parameter::Value<String>
  pTenableRoleName:
    Type: String
    Description: "IAM Role name to be created in each account for Tenable container in Security account."
    Default: RoleForTenableInSHAccount
  pConnectorRoleName:
    Type: String
    Description: The IAM trusted role must be set to "tenableio-connector"
    Default: tenableio-connector
  pPrincipalAws:
    Type: String
    Description: The Amazon Resource Name (ARN) of the Tenable.io AWS account to establish a trust relationship with.
    ConstraintDescription: The Amazon Resource Name (ARN) of the Tenable.io AWS account must be set to "arn:aws:iam::012615275169:role/keyless_connector"
    AllowedPattern: 'arn:aws:iam::[0-9]+:role+/.*'
  pTenableExternalId:
    Type: String
    Description: "The external ID from the connector configuration screen."
  pTenableContainerIAMRole:
    Type: String
    Description: Name of IAM Role for Tenable Container
    Default: TenableRole
  pTenableAccIdForSHProduct:
    Type: String
    Description: Tenable Account Id which is to be used for enabling findings in Security Hub
    Default: ""
  pSecretEncryptionKMSKeyArn:
    Type: String
    Description: Arn of KMS Key used for encrypting Tenable API credentials in SSM
    Default: ""
  pSecurityAccountId:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for AWS Security Account Id
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription:
      Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: /sra/control-tower/audit-account-id
  pCodeCommitRepositoryName:
    Type: String
    Description: Name of Tenable Code Commit Repository
    Default: "Tenable"
  pECRRepositoryName:
    Type: String
    Description: Name of Tenable ECR Repository
    Default: "tenable"
    AllowedPattern: '^(?=.{2,256}$)((?:[a-z0-9]+(?:[._-][a-z0-9]+)*/)*[a-z0-9]+(?:[._-][a-z0-9]+)*)$'
    ConstraintDescription:
     The repository name must start with a letter and can only contain lowercase letters, numbers, hyphens, underscores, and forward slashes.
  pVpcId:
    Type: String
    Description: VPC Id to launch network resources in
    Default: ""
  pSubnetIds:
    Type: String
    Description: Comma-separated list of Subnet Ids
    Default: ""
  pCreateVpc:
    Type: String
    Description: Use this to deploy a VPC rather than an existing VPC Id to launch network resources in
    AllowedValues:
      - "True"
      - "False"
    Default: "False"
  pVpcCidr:
    Type: String
    Description: The CIDR to be used for the VPC to be created if pCreateVpc = True to launch network resources in
    Default: "192.168.0.0/24"
  ##### Tagging Parameters
  pTagEnvironment:
    Type: String
    Description: Select the Name of the Environment
    AllowedValues:
      - Production
      - Non-Production
    Default: Production
  pTagSDLC:
    Type: String
    Description: Distinguish between SDLC Environments e.g., Dev, Test, SIT, UAT
    AllowedValues:
      - Dev
      - Test
      - SIT
      - UAT
      - Pre-Prod
      - Prod
    Default: Prod
  pTagApplicationName:
    Type: String
    Description: Identify resources that are related to a specific application
    Default: tenable
  pTagApplicationRole:
    Type: String
    Description: Identify the function of a particular resource e.g., Web Server, Message Broker, Database Server
    Default: Security
  pTagCluster:
    Type: String
    Description: Identify resource farms that share a common configuration and perform a specific function for an application
    Default: "N/A"
  pTagDataClassification:
    Type: String
    Description: Identify the specific data confidentiality level a resource supports
    AllowedValues:
      - Public
      - Private
      - Confidential
      - Restricted
    Default: Private
  pTagCompliance:
    Type: String
    Description: Identify the specific compliance requirements that resources must adhere to e.g., PCI-DSS, HIPAA, ISO27001
    Default: "N/A"
  pTagDataRetention:
    Type: String
    Description: Identify the data retention policy applied to the resources (S3, ECR, CloudWatch Logs, EC2 AMI, EBS Snapshots, RDS Snapshot)
    AllowedValues:
      - 1
      - 3
      - 5
      - 7
      - 14
      - 30
      - 60
      - 90
      - 120
      - 150
      - 180
      - 365
      - 400
      - 545
      - 731
      - 1827
      - 3653
    Default: 365
  pTagMapMigrated:
    Type: String
    Description: Identify resources that have been migrated as part of the AWS Migration Acceleration Program (MAP) for funding purposes
    Default: "N/A"
  pTagProjectName:
    Type: String
    Description: Identify projects that the resource supports
    Default: "tenable"
  pTagProductOwner:
    Type: String
    Description: Identify who is commercially responsible for the resource
    Default: "TBC"
  pTagTechnicalOwner:
    Type: String
    Description: Identify who is technically responsible for the resource
    Default: "TBC"
  pTagCostCenter:
    Type: String
    Description: Identify the cost center associated with a resource, typically for cost allocation and tracking
  pTagBusinessUnit:
    Type: String
    Description: Identify the business unit associated with a resource, typically for cost allocation and tracking
  pTagBusinessImpact:
    Type: String
    Description: Identify the business impact associated with the resource
    AllowedValues:
      - Critical
      - High
      - Medium
      - Low
    Default: Medium
  pTagEscalationPath:
    Type: String
    Description: Identify the next point of contact for a resource in an incident e.g, DevOps Team, 3rd Party Company
    Default: "TBC"
  pTagKnowledgeBase:
    Type: String
    Description: Identifies the location for knowledge base articles/wikis for the resource
    Default: "TBC"
  pTagHoursOfOperation:
    Type: String
    Description: Identify the hours of operation for a resource e.g., 24*7, 06:00 - 22:00 Monday - Friday, 08:00 - 18:00 Monday - Friday
    AllowedValues:
      - 24x7
      - 16x5
      - 9x5
    Default: 24x7
  pTagMaintenanceWindow:
    Type: String
    Description: Identify the hours in which a resource is available for maintenance to occur
    Default: "N/A"
    Default: "N/A"
  pTagBackupSchedule:
    Type: String
    Description: Identify the backup schedule for a resource
    Default: "N/A"
  pTagOptOut:
    Type: String
    Description: Identify whether a resource should be excluded from maintenance activities e.g., True, False
    AllowedValues:
      - "True"
      - "False"
    Default: "False"
  pTagDeploymentMethod:
    Type: String
    Description: Identify the method by which resources are deployed
    AllowedValues:
      - CloudFormation
      - Terraform
      - Manual
    Default: CloudFormation
Conditions:
  CreateVpc: !Equals
    - !Ref pCreateVpc
    - "True"
Resources:
  rTenableVpcStackSet:
    Type: AWS::CloudFormation::StackSet
    Condition: CreateVpc
    Properties:
      StackSetName: tenable-vpc
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: "This Template will create the VPC for running Tenable as a Fargate container"
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            AccountFilterType: INTERSECTION
            OrganizationalUnitIds:
              - !Ref pRootOrganizationalUnitId
            Accounts:
              - !Ref pSecurityAccountId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-vpc.yaml"]]
      Parameters:
        - ParameterKey: pVpcCidr
          ParameterValue: !Ref pVpcCidr
        - ParameterKey: pGLCTSolutionVersion
          ParameterValue: !Ref pGLCTSolutionVersion
        ### tagging parameters
        - ParameterKey: pTagEnvironment
          ParameterValue: !Ref pTagEnvironment
        - ParameterKey: pTagSDLC
          ParameterValue: !Ref pTagSDLC
        - ParameterKey: pTagApplicationName
          ParameterValue: !Ref pTagApplicationName
        - ParameterKey: pTagApplicationRole
          ParameterValue: !Ref pTagApplicationRole
        - ParameterKey: pTagCluster
          ParameterValue: !Ref pTagCluster
        - ParameterKey: pTagDataClassification
          ParameterValue: !Ref pTagDataClassification
        - ParameterKey: pTagCompliance
          ParameterValue: !Ref pTagCompliance
        - ParameterKey: pTagDataRetention
          ParameterValue: !Ref pTagDataRetention
        - ParameterKey: pTagMapMigrated
          ParameterValue: !Ref pTagMapMigrated
        - ParameterKey: pTagProjectName
          ParameterValue: !Ref pTagProjectName
        - ParameterKey: pTagProductOwner
          ParameterValue: !Ref pTagProductOwner
        - ParameterKey: pTagTechnicalOwner
          ParameterValue: !Ref pTagTechnicalOwner
        - ParameterKey: pTagCostCenter
          ParameterValue: !Ref pTagCostCenter
        - ParameterKey: pTagBusinessUnit
          ParameterValue: !Ref pTagBusinessUnit
        - ParameterKey: pTagBusinessImpact
          ParameterValue: !Ref pTagBusinessImpact
        - ParameterKey: pTagEscalationPath
          ParameterValue: !Ref pTagEscalationPath
        - ParameterKey: pTagKnowledgeBase
          ParameterValue: !Ref pTagKnowledgeBase
        - ParameterKey: pTagHoursOfOperation
          ParameterValue: !Ref pTagHoursOfOperation
        - ParameterKey: pTagMaintenanceWindow
          ParameterValue: !Ref pTagMaintenanceWindow
        - ParameterKey: pTagBackupSchedule
          ParameterValue: !Ref pTagBackupSchedule
        - ParameterKey: pTagOptOut
          ParameterValue: !Ref pTagOptOut
        - ParameterKey: pTagDeploymentMethod
          ParameterValue: !Ref pTagDeploymentMethod
  rTenableReposAndPipelineStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: tenable-repositories-and-pipeline
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: "This Template will create tenable Repositories and Pipeline for image building"
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            AccountFilterType: INTERSECTION
            OrganizationalUnitIds:
              - !Ref pRootOrganizationalUnitId
            Accounts:
              - !Ref pSecurityAccountId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-pipeline.yaml"]]
      Parameters:
        - ParameterKey: pGLCTSolutionVersion
          ParameterValue: !Ref pGLCTSolutionVersion
        - ParameterKey: pCodeCommitRepositoryName
          ParameterValue: !Ref pCodeCommitRepositoryName
        - ParameterKey: pECRRepositoryName
          ParameterValue: !Ref pECRRepositoryName
        - ParameterKey: pTagEnvironment
          ParameterValue: !Ref pTagEnvironment
        - ParameterKey: pTagSDLC
          ParameterValue: !Ref pTagSDLC
        - ParameterKey: pTagApplicationName
          ParameterValue: !Ref pTagApplicationName
        - ParameterKey: pTagApplicationRole
          ParameterValue: !Ref pTagApplicationRole
        - ParameterKey: pTagCluster
          ParameterValue: !Ref pTagCluster
        - ParameterKey: pTagDataClassification
          ParameterValue: !Ref pTagDataClassification
        - ParameterKey: pTagCompliance
          ParameterValue: !Ref pTagCompliance
        - ParameterKey: pTagDataRetention
          ParameterValue: !Ref pTagDataRetention
        - ParameterKey: pTagMapMigrated
          ParameterValue: !Ref pTagMapMigrated
        - ParameterKey: pTagProjectName
          ParameterValue: !Ref pTagProjectName
        - ParameterKey: pTagProductOwner
          ParameterValue: !Ref pTagProductOwner
        - ParameterKey: pTagTechnicalOwner
          ParameterValue: !Ref pTagTechnicalOwner
        - ParameterKey: pTagCostCenter
          ParameterValue: !Ref pTagCostCenter
        - ParameterKey: pTagBusinessUnit
          ParameterValue: !Ref pTagBusinessUnit
        - ParameterKey: pTagBusinessImpact
          ParameterValue: !Ref pTagBusinessImpact
        - ParameterKey: pTagEscalationPath
          ParameterValue: !Ref pTagEscalationPath
        - ParameterKey: pTagKnowledgeBase
          ParameterValue: !Ref pTagKnowledgeBase
        - ParameterKey: pTagHoursOfOperation
          ParameterValue: !Ref pTagHoursOfOperation
        - ParameterKey: pTagMaintenanceWindow
          ParameterValue: !Ref pTagMaintenanceWindow
        - ParameterKey: pTagBackupSchedule
          ParameterValue: !Ref pTagBackupSchedule
        - ParameterKey: pTagOptOut
          ParameterValue: !Ref pTagOptOut
        - ParameterKey: pTagDeploymentMethod
          ParameterValue: !Ref pTagDeploymentMethod
  rTenableConnectorRoleStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: Tenable-Keyless-Cloud-Connector-Role
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: "CloudFormation Template to create IAM Role to be assumed AWS Frictionless Connector in Tenable.io"
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref pRootOrganizationalUnitId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-connector-role.yaml"]]
      Parameters:
        - ParameterKey: pGLCTSolutionVersion
          ParameterValue: !Ref pGLCTSolutionVersion
        - ParameterKey: pPrincipalAws
          ParameterValue: !Ref pPrincipalAws
        - ParameterKey: pRoleName
          ParameterValue: !Ref pConnectorRoleName
        - ParameterKey: pTenableExternalId
          ParameterValue: !Ref pTenableExternalId
        - ParameterKey: pTagEnvironment
          ParameterValue: !Ref pTagEnvironment
        - ParameterKey: pTagSDLC
          ParameterValue: !Ref pTagSDLC
        - ParameterKey: pTagApplicationName
          ParameterValue: !Ref pTagApplicationName
        - ParameterKey: pTagApplicationRole
          ParameterValue: !Ref pTagApplicationRole
        - ParameterKey: pTagCluster
          ParameterValue: !Ref pTagCluster
        - ParameterKey: pTagDataClassification
          ParameterValue: !Ref pTagDataClassification
        - ParameterKey: pTagCompliance
          ParameterValue: !Ref pTagCompliance
        - ParameterKey: pTagDataRetention
          ParameterValue: !Ref pTagDataRetention
        - ParameterKey: pTagProjectName
          ParameterValue: !Ref pTagProjectName
        - ParameterKey: pTagMapMigrated
          ParameterValue: !Ref pTagMapMigrated
        - ParameterKey: pTagProductOwner
          ParameterValue: !Ref pTagProductOwner
        - ParameterKey: pTagTechnicalOwner
          ParameterValue: !Ref pTagTechnicalOwner
        - ParameterKey: pTagBusinessUnit
          ParameterValue: !Ref pTagBusinessUnit
        - ParameterKey: pTagCostCenter
          ParameterValue: !Ref pTagCostCenter
        - ParameterKey: pTagBusinessImpact
          ParameterValue: !Ref pTagBusinessImpact
        - ParameterKey: pTagEscalationPath
          ParameterValue: !Ref pTagEscalationPath
        - ParameterKey: pTagKnowledgeBase
          ParameterValue: !Ref pTagKnowledgeBase
        - ParameterKey: pTagHoursOfOperation
          ParameterValue: !Ref pTagHoursOfOperation
        - ParameterKey: pTagMaintenanceWindow
          ParameterValue: !Ref pTagMaintenanceWindow
        - ParameterKey: pTagBackupSchedule
          ParameterValue: !Ref pTagBackupSchedule
        - ParameterKey: pTagOptOut
          ParameterValue: !Ref pTagOptOut
        - ParameterKey: pTagDeploymentMethod
          ParameterValue: !Ref pTagDeploymentMethod
  rTenableConnectorRoleStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-connector-role.yaml"]]
      Parameters:
        pGLCTSolutionVersion: !Ref pGLCTSolutionVersion
        pPrincipalAws: !Ref pPrincipalAws
        pRoleName: !Ref pConnectorRoleName
        pTenableExternalId: !Ref pTenableExternalId
        pTagEnvironment: !Ref pTagEnvironment
        pTagSDLC: !Ref pTagSDLC
        pTagApplicationName: !Ref pTagApplicationName
        pTagApplicationRole: !Ref pTagApplicationRole
        pTagCluster: !Ref pTagCluster
        pTagDataClassification: !Ref pTagDataClassification
        pTagCompliance: !Ref pTagCompliance
        pTagDataRetention: !Ref pTagDataRetention
        pTagProjectName: !Ref pTagProjectName
        pTagMapMigrated: !Ref pTagMapMigrated
        pTagProductOwner: !Ref pTagProductOwner
        pTagTechnicalOwner: !Ref pTagTechnicalOwner
        pTagBusinessUnit: !Ref pTagBusinessUnit
        pTagCostCenter: !Ref pTagCostCenter
        pTagBusinessImpact: !Ref pTagBusinessImpact
        pTagEscalationPath: !Ref pTagEscalationPath
        pTagKnowledgeBase: !Ref pTagKnowledgeBase
        pTagHoursOfOperation: !Ref pTagHoursOfOperation
        pTagMaintenanceWindow: !Ref pTagMaintenanceWindow
        pTagBackupSchedule: !Ref pTagBackupSchedule
        pTagOptOut: !Ref pTagOptOut
        pTagDeploymentMethod: !Ref pTagDeploymentMethod
  rTenableTaskRoleStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: tenable-task-role
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: "This Template will create IAM Role required by Tenable Fargate Container"
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            AccountFilterType: INTERSECTION
            OrganizationalUnitIds:
              - !Ref pRootOrganizationalUnitId
            Accounts:
              - !Ref pSecurityAccountId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-task-role.yaml"]]
      Parameters:
        - ParameterKey: pGLCTSolutionVersion
          ParameterValue: !Ref pGLCTSolutionVersion
        - ParameterKey: pTagEnvironment
          ParameterValue: !Ref pTagEnvironment
        - ParameterKey: pTagSDLC
          ParameterValue: !Ref pTagSDLC
        - ParameterKey: pTagApplicationName
          ParameterValue: !Ref pTagApplicationName
        - ParameterKey: pTagApplicationRole
          ParameterValue: !Ref pTagApplicationRole
        - ParameterKey: pTagCluster
          ParameterValue: !Ref pTagCluster
        - ParameterKey: pTagDataClassification
          ParameterValue: !Ref pTagDataClassification
        - ParameterKey: pTagCompliance
          ParameterValue: !Ref pTagCompliance
        - ParameterKey: pTagDataRetention
          ParameterValue: !Ref pTagDataRetention
        - ParameterKey: pTagMapMigrated
          ParameterValue: !Ref pTagMapMigrated
        - ParameterKey: pTagProjectName
          ParameterValue: !Ref pTagProjectName
        - ParameterKey: pTagProductOwner
          ParameterValue: !Ref pTagProductOwner
        - ParameterKey: pTagTechnicalOwner
          ParameterValue: !Ref pTagTechnicalOwner
        - ParameterKey: pTagCostCenter
          ParameterValue: !Ref pTagCostCenter
        - ParameterKey: pTagBusinessUnit
          ParameterValue: !Ref pTagBusinessUnit
        - ParameterKey: pTagBusinessImpact
          ParameterValue: !Ref pTagBusinessImpact
        - ParameterKey: pTagEscalationPath
          ParameterValue: !Ref pTagEscalationPath
        - ParameterKey: pTagKnowledgeBase
          ParameterValue: !Ref pTagKnowledgeBase
        - ParameterKey: pTagHoursOfOperation
          ParameterValue: !Ref pTagHoursOfOperation
        - ParameterKey: pTagMaintenanceWindow
          ParameterValue: !Ref pTagMaintenanceWindow
        - ParameterKey: pTagBackupSchedule
          ParameterValue: !Ref pTagBackupSchedule
        - ParameterKey: pTagOptOut
          ParameterValue: !Ref pTagOptOut
        - ParameterKey: pTagDeploymentMethod
          ParameterValue: !Ref pTagDeploymentMethod
  rTenableRoleStackSet:
    DependsOn:
          - "rTenableTaskRoleStackSet"
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: role-for-tenable-in-sec-acc
      AutoDeployment:
        Enabled: true
        RetainStacksOnAccountRemoval: false
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: "CloudFormation Template to create IAM Role to be assumed by Tenable container in Security Account"
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 100
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            OrganizationalUnitIds:
              - !Ref pRootOrganizationalUnitId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-role.yaml"]]
      Parameters:
        - ParameterKey: pGLCTSolutionVersion
          ParameterValue: !Ref pGLCTSolutionVersion
        - ParameterKey: pTenableContainerIAMRole
          ParameterValue: !Ref pTenableContainerIAMRole
        - ParameterKey: pSHAccountId
          ParameterValue: !Ref pSecurityAccountId
        - ParameterKey: pRoleName
          ParameterValue: !Ref pTenableRoleName
        - ParameterKey: pTagEnvironment
          ParameterValue: !Ref pTagEnvironment
        - ParameterKey: pTagSDLC
          ParameterValue: !Ref pTagSDLC
        - ParameterKey: pTagApplicationName
          ParameterValue: !Ref pTagApplicationName
        - ParameterKey: pTagApplicationRole
          ParameterValue: !Ref pTagApplicationRole
        - ParameterKey: pTagCluster
          ParameterValue: !Ref pTagCluster
        - ParameterKey: pTagDataClassification
          ParameterValue: !Ref pTagDataClassification
        - ParameterKey: pTagCompliance
          ParameterValue: !Ref pTagCompliance
        - ParameterKey: pTagDataRetention
          ParameterValue: !Ref pTagDataRetention
        - ParameterKey: pTagProjectName
          ParameterValue: !Ref pTagProjectName
        - ParameterKey: pTagMapMigrated
          ParameterValue: !Ref pTagMapMigrated
        - ParameterKey: pTagProductOwner
          ParameterValue: !Ref pTagProductOwner
        - ParameterKey: pTagTechnicalOwner
          ParameterValue: !Ref pTagTechnicalOwner
        - ParameterKey: pTagBusinessUnit
          ParameterValue: !Ref pTagBusinessUnit
        - ParameterKey: pTagCostCenter
          ParameterValue: !Ref pTagCostCenter
        - ParameterKey: pTagBusinessImpact
          ParameterValue: !Ref pTagBusinessImpact
        - ParameterKey: pTagEscalationPath
          ParameterValue: !Ref pTagEscalationPath
        - ParameterKey: pTagKnowledgeBase
          ParameterValue: !Ref pTagKnowledgeBase
        - ParameterKey: pTagHoursOfOperation
          ParameterValue: !Ref pTagHoursOfOperation
        - ParameterKey: pTagMaintenanceWindow
          ParameterValue: !Ref pTagMaintenanceWindow
        - ParameterKey: pTagBackupSchedule
          ParameterValue: !Ref pTagBackupSchedule
        - ParameterKey: pTagOptOut
          ParameterValue: !Ref pTagOptOut
        - ParameterKey: pTagDeploymentMethod
          ParameterValue: !Ref pTagDeploymentMethod
  rTenableRoleStack:
    DependsOn:
        - "rTenableTaskRoleStackSet"
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-role.yaml"]]
      Parameters:
        pRoleName: !Ref pTenableRoleName
        pTenableContainerIAMRole: !Ref pTenableContainerIAMRole
        pSHAccountId: !Ref pSecurityAccountId
        pGLCTSolutionVersion: !Ref pGLCTSolutionVersion
        pTagEnvironment: !Ref pTagEnvironment
        pTagSDLC: !Ref pTagSDLC
        pTagApplicationName: !Ref pTagApplicationName
        pTagApplicationRole: !Ref pTagApplicationRole
        pTagCluster: !Ref pTagCluster
        pTagDataClassification: !Ref pTagDataClassification
        pTagCompliance: !Ref pTagCompliance
        pTagDataRetention: !Ref pTagDataRetention
        pTagProjectName: !Ref pTagProjectName
        pTagMapMigrated: !Ref pTagMapMigrated
        pTagProductOwner: !Ref pTagProductOwner
        pTagTechnicalOwner: !Ref pTagTechnicalOwner
        pTagBusinessUnit: !Ref pTagBusinessUnit
        pTagCostCenter: !Ref pTagCostCenter
        pTagBusinessImpact: !Ref pTagBusinessImpact
        pTagEscalationPath: !Ref pTagEscalationPath
        pTagKnowledgeBase: !Ref pTagKnowledgeBase
        pTagHoursOfOperation: !Ref pTagHoursOfOperation
        pTagMaintenanceWindow: !Ref pTagMaintenanceWindow
        pTagBackupSchedule: !Ref pTagBackupSchedule
        pTagOptOut: !Ref pTagOptOut
        pTagDeploymentMethod: !Ref pTagDeploymentMethod
  rWaitTenableVpc:
    Type: AWS::CloudFormation::WaitConditionHandle
    Metadata:
      VpcReady: !If [CreateVpc, !Ref rTenableVpcStackSet, !Ref AWS::NoValue]
  rTenableInfraStackSet:
    DependsOn:
         - "rTenableReposAndPipelineStackSet"
         - "rTenableTaskRoleStackSet"
         - "rTenableRoleStackSet"
         - "rTenableRoleStack"
         - "rWaitTenableVpc"
    Type: AWS::CloudFormation::StackSet
    Properties:
      StackSetName: Tenable-Infra
      AdministrationRoleARN: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/service-role/AWSControlTowerStackSetRole
      CallAs: SELF
      Capabilities:
        - CAPABILITY_NAMED_IAM
      Description: This Template will create the infrastructure for running Tenable as a Fargate container
      ExecutionRoleName: AWSControlTowerExecution
      ManagedExecution:
        Active: true
      OperationPreferences:
        FailureTolerancePercentage: 0
        MaxConcurrentPercentage: 100
        RegionConcurrencyType: PARALLEL
      PermissionModel: SELF_MANAGED
      StackInstancesGroup:
        - DeploymentTargets:
            Accounts:
              - !Ref pSecurityAccountId
          Regions:
            - !Ref AWS::Region
      TemplateURL: !Join ["", [!Ref pS3BaseURLForNestedTemplates, "tenable/nested/tenable-infra.yaml"]]
      Parameters:
        - ParameterKey: pGLCTSolutionVersion
          ParameterValue: !Ref pGLCTSolutionVersion
        - ParameterKey: pTenableIAMRoleName
          ParameterValue: !Ref pTenableRoleName
        - ParameterKey: pTenableContainerIAMRole
          ParameterValue: !Ref pTenableContainerIAMRole
        - ParameterKey: pTenableContainerUri
          ParameterValue: !Sub "${pSecurityAccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${pECRRepositoryName}:latest"
        - ParameterKey: pTenableAccIdForSHProduct
          ParameterValue: !Ref pTenableAccIdForSHProduct
        - ParameterKey: pSecretEncryptionKMSKeyArn
          ParameterValue: !Ref pSecretEncryptionKMSKeyArn
        - ParameterKey: pVpcId
          ParameterValue: !Ref pVpcId
        - ParameterKey: pSubnetIds
          ParameterValue: !Ref pSubnetIds
        - ParameterKey: pTagEnvironment
          ParameterValue: !Ref pTagEnvironment
        - ParameterKey: pTagSDLC
          ParameterValue: !Ref pTagSDLC
        - ParameterKey: pTagApplicationName
          ParameterValue: !Ref pTagApplicationName
        - ParameterKey: pTagApplicationRole
          ParameterValue: !Ref pTagApplicationRole
        - ParameterKey: pTagCluster
          ParameterValue: !Ref pTagCluster
        - ParameterKey: pTagDataClassification
          ParameterValue: !Ref pTagDataClassification
        - ParameterKey: pTagCompliance
          ParameterValue: !Ref pTagCompliance
        - ParameterKey: pTagDataRetention
          ParameterValue: !Ref pTagDataRetention
        - ParameterKey: pTagProjectName
          ParameterValue: !Ref pTagProjectName
        - ParameterKey: pTagMapMigrated
          ParameterValue: !Ref pTagMapMigrated
        - ParameterKey: pTagProductOwner
          ParameterValue: !Ref pTagProductOwner
        - ParameterKey: pTagTechnicalOwner
          ParameterValue: !Ref pTagTechnicalOwner
        - ParameterKey: pTagBusinessUnit
          ParameterValue: !Ref pTagBusinessUnit
        - ParameterKey: pTagCostCenter
          ParameterValue: !Ref pTagCostCenter
        - ParameterKey: pTagBusinessImpact
          ParameterValue: !Ref pTagBusinessImpact
        - ParameterKey: pTagEscalationPath
          ParameterValue: !Ref pTagEscalationPath
        - ParameterKey: pTagKnowledgeBase
          ParameterValue: !Ref pTagKnowledgeBase
        - ParameterKey: pTagHoursOfOperation
          ParameterValue: !Ref pTagHoursOfOperation
        - ParameterKey: pTagMaintenanceWindow
          ParameterValue: !Ref pTagMaintenanceWindow
        - ParameterKey: pTagBackupSchedule
          ParameterValue: !Ref pTagBackupSchedule
        - ParameterKey: pTagOptOut
          ParameterValue: !Ref pTagOptOut
        - ParameterKey: pTagDeploymentMethod
          ParameterValue: !Ref pTagDeploymentMethod